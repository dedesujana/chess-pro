<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Chess Pro - Elite AI Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root { --p: #2ecc71; --b: #0a0a0a; --c: #151515; --s: #3498db; --r: #e74c3c; }
        body { font-family: 'Inter', sans-serif; background: var(--b); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app { background: var(--c); width: 90%; max-width: 400px; padding: 30px; border-radius: 25px; border: 1px solid #222; box-shadow: 0 40px 80px rgba(0,0,0,0.8); text-align: center; }
        
        input { width: 100%; padding: 15px; margin: 10px 0; background: #111; border: 1px solid #333; color: white; border-radius: 12px; box-sizing: border-box; outline: none; }
        button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; transition: 0.3s; }
        button:disabled { background: #333; opacity: 0.5; }
        .btn-bot { background: var(--s); margin-top: 5px; }
        .btn-mode { background: #222; border: 1px solid #444; margin: 5px 0; font-size: 13px; }
        .btn-mode:hover { background: #333; }
        
        #menu, #game, #reg, #bot-menu { display: none; }
        .lobby { background: #000; border-radius: 15px; padding: 15px; margin-top: 20px; border: 1px solid #222; height: 150px; overflow-y: auto; }
        .p-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1a1a1a; margin-bottom: 8px; border-radius: 10px; border-left: 4px solid var(--s); }
        
        .cap-box { background: #fff; border-radius: 3px; padding: 10px; margin: 15px 0; display: flex; align-items: center; border: 1px solid #d3d3d3; color: #555; text-align: left; }
        .chk { width: 22px; height: 22px; border: 2px solid #c1c1c1; margin-right: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: white; }
        .chk.spin { border-radius: 50%; border-top-color: #4285f4; animation: s 0.8s infinite linear; }
        .chk.ok { background: var(--p); border-color: var(--p); color: white; }
        .chk.ok::after { content: 'âœ”'; }
        @keyframes s { to { transform: rotate(360deg); } }

        #board { width: 100%; margin: 20px 0; border: 4px solid #333; border-radius: 10px; overflow: hidden; }
        .pop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="app">
        <div id="login">
            <h1 style="color: var(--p); margin: 0;">CHESS PRO</h1>
            <p style="font-size: 10px; color: #666; letter-spacing: 2px; margin-bottom: 30px;">AI & MULTIPLAYER</p>
            <input type="text" id="l-u" placeholder="Username">
            <input type="password" id="l-p" placeholder="Password">
            <div class="cap-box">
                <div class="chk" id="l-c" onclick="v('login')"></div>
                <div style="font-size: 13px;">I'm not a robot</div>
            </div>
            <button id="l-b" onclick="hL()" disabled>MASUK</button>
            <p style="font-size: 12px;">Baru? <span onclick="go('reg')" style="color:var(--p); cursor:pointer;">Daftar</span></p>
        </div>

        <div id="reg">
            <h2>DAFTAR</h2>
            <input type="text" id="r-u" placeholder="Username">
            <input type="password" id="r-p" placeholder="Password">
            <div class="cap-box">
                <div class="chk" id="r-c" onclick="v('reg')"></div>
                <div style="font-size: 13px;">I'm not a robot</div>
            </div>
            <button id="r-b" onclick="hR()" disabled>DAFTAR</button>
            <p style="font-size: 12px;"><span onclick="go('login')" style="color:var(--p); cursor:pointer;">Balik</span></p>
        </div>

        <div id="menu">
            <div id="my-u" style="font-size: 24px; font-weight: bold; color: var(--p); text-align: left; margin-bottom: 20px;"></div>
            <button class="btn-bot" onclick="go('bot-menu')">VS KOMPUTER (AI)</button>
            <div class="lobby"><div id="plist"></div></div>
            <button onclick="lo()" style="background:none; border:1px solid #333; color:#555; margin-top:20px; font-size:11px;">LOGOUT</button>
        </div>

        <div id="bot-menu">
            <h3>PILIH LEVEL AI</h3>
            <button class="btn-mode" onclick="startBot('easy')">EASY (Asal Jalan)</button>
            <button class="btn-mode" onclick="startBot('medium')">MEDIUM (Mulai Makan)</button>
            <button class="btn-mode" onclick="startBot('hard')">HARD (Cukup Sulit)</button>
            <button onclick="go('menu')" style="background:none; color:var(--r)">BATAL</button>
        </div>

        <div id="game">
            <div id="st" style="font-size: 11px; margin-bottom: 10px; color:#888;"></div>
            <div id="board"></div>
            <button onclick="rs()" style="background: var(--r);">MENYERAH / KELUAR</button>
        </div>
    </div>

    <div class="pop" id="fin">
        <h1 id="f-t" style="font-size: 50px;"></h1>
        <button onclick="location.reload()" style="width: 200px;">KE LOBBY</button>
    </div>

    <script>
        let b, g = new Chess(), p = new Peer(), cn = null, sd = '', mid = '', botLevel = null;
        let me = "", vOk = { login: false, reg: false };
        let db = JSON.parse(localStorage.getItem('chess_v_ai_1') || '{}');

        // --- AUTH SYSTEM ---
        function v(m) {
            if(vOk[m]) return;
            $(`#${m[0]}-c`).addClass('spin');
            setTimeout(() => { $(`#${m[0]}-c`).removeClass('spin').addClass('ok'); vOk[m]=true; $(`#${m[0]}-b`).prop('disabled', false); }, 800);
        }
        function go(m) { 
            $('#login,#reg,#menu,#bot-menu,#game').hide(); 
            $(`#${m}`).fadeIn(); 
        }
        function hR() {
            let u=$('#r-u').val().trim(), p=$('#r-p').val().trim();
            if(!u || db[u]) return alert("User ada!");
            db[u]={p}; localStorage.setItem('chess_v_ai_1', JSON.stringify(db)); st(u);
        }
        function hL() {
            let u=$('#l-u').val().trim(), p=$('#l-p').val().trim();
            if(db[u] && db[u].p===p) st(u); else alert("Salah!");
        }
        function st(u) {
            me=u; sessionStorage.setItem('u', u);
            go('menu'); $('#my-u').text(u);
            loop();
        }

        // --- MULTIPLAYER SYSTEM ---
        p.on('open', (id) => mid=id);
        p.on('connection', (c) => {
            cn = c;
            cn.on('data', (d) => {
                if(d.t==='I') { if(confirm(d.f+" mengajak main!")) { sd='white'; cn.send({t:'A',f:me}); ln('white', false); } }
                else if(d.t==='A') { sd='black'; ln('black', false); }
                else if(d.t==='M') { g.move(d.m); b.position(g.fen()); chk(); }
                else if(d.t==='R') { end("MENANG"); }
            });
        });
        function loop() {
            setInterval(() => {
                if(!me || !$('#menu').is(':visible')) return;
                localStorage.setItem('on_'+mid, JSON.stringify({n:me, t:Date.now()}));
                $('#plist').empty();
                for(let i=0; i<localStorage.length; i++){
                    let k=localStorage.key(i);
                    if(k.startsWith('on_') && k!=='on_'+mid){
                        let x=JSON.parse(localStorage.getItem(k));
                        if(Date.now()-x.t < 4000) $('#plist').append(`<div class="p-card"><b>${x.n}</b> <button onclick="inv('${k.split('_')[1]}')" style="width:70px; padding:6px; margin:0; font-size:11px;">TANTANG</button></div>`);
                    }
                }
            }, 3000);
        }
        function inv(tid) { cn=p.connect(tid); cn.on('open', () => cn.send({t:'I', f:me})); }

        // --- AI BOT ENGINE ---
        function startBot(lv) {
            botLevel = lv;
            sd = 'white';
            ln('white', true);
        }

        function makeBotMove() {
            if (g.game_over()) return;
            let moves = g.moves();
            let move;

            if (botLevel === 'easy') {
                move = moves[Math.floor(Math.random() * moves.length)];
            } else {
                // Medium & Hard use basic piece value evaluation
                moves.sort((a, b) => {
                    let moveA = g.move(a); g.undo();
                    let moveB = g.move(b); g.undo();
                    return (moveB.captured ? 1 : 0) - (moveA.captured ? 1 : 0);
                });
                move = (botLevel === 'hard' && Math.random() > 0.2) ? moves[0] : moves[Math.floor(Math.random() * Math.min(3, moves.length))];
            }

            g.move(move);
            b.position(g.fen());
            chk();
        }

        // --- CORE GAME ---
        function ln(s, isBot) {
            go('game');
            g.reset();
            $('#st').text(isBot ? "MODE: VS BOT (" + botLevel.toUpperCase() + ")" : "MODE: ONLINE VS PLAYER");
            setTimeout(() => {
                b = Chessboard('board', {
                    draggable: true, orientation: s, position: 'start',
                    onDragStart: (x,y,p) => { if(g.game_over() || g.turn()!==s[0]) return false; },
                    onDrop: (x,y) => {
                        let m=g.move({from:x, to:y, promotion:'q'});
                        if(!m) return 'snapback';
                        if(!isBot) cn.send({t:'M', m:m});
                        chk();
                        if(isBot) setTimeout(makeBotMove, 600);
                    },
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
            }, 500);
        }

        function chk() { if(g.game_over()) end(g.in_checkmate() ? (g.turn()===sd[0]?"KALAH":"MENANG") : "SERI"); }
        function end(t) { $('#f-t').text(t); $('#fin').css('display','flex'); }
        function lo() { sessionStorage.clear(); location.reload(); }
        function rs() { if(confirm("Keluar dari game?")) location.reload(); }

        $(document).ready(() => { let s=sessionStorage.getItem('u'); if(s && db[s]) st(s); });
    </script>
</body>
</html>
