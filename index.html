<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Pro - Manual Connect</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root { --p: #2ecc71; --b: #0a0a0a; --c: #151515; --s: #3498db; --r: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--b); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app { background: var(--c); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid #333; box-shadow: 0 30px 60px rgba(0,0,0,0.8); text-align: center; }
        
        input { width: 100%; padding: 14px; margin: 8px 0; background: #111; border: 1px solid #333; color: white; border-radius: 10px; box-sizing: border-box; text-align: center; }
        button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; transition: 0.2s; }
        .btn-blue { background: var(--s); }
        .btn-red { background: var(--r); }
        .btn-outline { background: transparent; border: 1px solid #444; color: #888; margin-top: 15px; }
        
        #menu, #game, #reg, #bot-menu, #multi-menu { display: none; }
        .id-box { background: #000; padding: 10px; border-radius: 8px; border: 1px dashed var(--s); font-family: monospace; color: var(--s); font-size: 18px; margin: 10px 0; cursor: pointer; }
        
        #board { width: 100%; margin: 15px 0; border: 4px solid #333; border-radius: 8px; }
        .pop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="app">
        <div id="login">
            <h1 style="color: var(--p); margin: 0;">CHESS PRO</h1>
            <p style="font-size: 11px; color: #555; margin-bottom: 25px;">STABLE EDITION</p>
            <input type="text" id="l-u" placeholder="Username">
            <input type="password" id="l-p" placeholder="Password">
            <button onclick="hLogin()">MASUK</button>
            <p style="font-size: 12px;">Baru? <span onclick="nav('reg')" style="color:var(--p); cursor:pointer;">Daftar</span></p>
        </div>

        <div id="reg">
            <h2>BUAT AKUN</h2>
            <input type="text" id="r-u" placeholder="Pilih Username">
            <input type="password" id="r-p" placeholder="Pilih Password">
            <button onclick="hReg()">DAFTAR SEKARANG</button>
            <p style="font-size: 12px;"><span onclick="nav('login')" style="color:var(--p); cursor:pointer;">Kembali</span></p>
        </div>

        <div id="menu">
            <div id="u-display" style="font-size: 20px; font-weight: bold; color: var(--p); margin-bottom: 20px;"></div>
            <button class="btn-blue" onclick="nav('multi-menu')">MULTIPLAYER (HOST/ADD)</button>
            <button onclick="nav('bot-menu')">VS KOMPUTER (AI)</button>
            <button class="btn-outline" onclick="logout()">LOGOUT</button>
        </div>

        <div id="multi-menu">
            <h3>MULTIPLAYER</h3>
            <p style="font-size: 12px; color: #888;">ID Kamu (Berikan ke teman):</p>
            <div class="id-box" id="my-id" onclick="copyID()">MEMUAT ID...</div>
            
            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
            
            <p style="font-size: 12px; color: #888;">Masukkan ID Teman (ADD):</p>
            <input type="text" id="join-id" placeholder="Paste ID Teman Disini">
            <button class="btn-blue" onclick="joinGame()">ADD & PLAY</button>
            <button class="btn-outline" onclick="nav('menu')">KEMBALI</button>
        </div>

        <div id="bot-menu">
            <h3>PILIH LEVEL AI</h3>
            <button onclick="startAI('easy')">EASY</button>
            <button class="btn-blue" onclick="startAI('medium')">MEDIUM</button>
            <button class="btn-red" onclick="startAI('hard')">HARD</button>
            <button class="btn-outline" onclick="nav('menu')">BATAL</button>
        </div>

        <div id="game">
            <div id="g-status" style="font-size: 11px; color: #888;"></div>
            <div id="board"></div>
            <button class="btn-red" onclick="resign()">KELUAR / MENYERAH</button>
        </div>
    </div>

    <div class="pop" id="res-modal">
        <h1 id="res-text" style="font-size: 50px;"></h1>
        <button onclick="location.reload()" style="width: 200px;">BALIK KE MENU</button>
    </div>

    <script>
        let board, game = new Chess(), peer = new Peer(), conn = null, mySide = '', botLV = null;
        let me = "";
        let db = JSON.parse(localStorage.getItem('chess_manual_db') || '{}');

        // --- PEER SETUP ---
        peer.on('open', (id) => { $('#my-id').text(id); });
        
        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if(data.t === 'INV') {
                    if(confirm("Ada tantangan masuk! Main?")) {
                        mySide = 'white'; conn.send({t:'ACC'}); initG('white', false);
                    }
                } else if(data.t === 'ACC') {
                    mySide = 'black'; initG('black', false);
                } else if(data.t === 'MOV') {
                    game.move(data.m); board.position(game.fen()); checkEnd();
                } else if(data.t === 'RES') { finish("MENANG"); }
            });
        });

        function joinGame() {
            let tid = $('#join-id').val().trim();
            if(!tid) return alert("Masukkan ID dulu!");
            conn = peer.connect(tid);
            conn.on('open', () => {
                alert("Menghubungkan ke teman...");
                conn.send({t:'INV'});
            });
        }

        function copyID() {
            let id = $('#my-id').text();
            navigator.clipboard.writeText(id);
            alert("ID Disalin: " + id);
        }

        // --- NAVIGATION & AUTH ---
        function nav(id) { $('#login,#reg,#menu,#bot-menu,#multi-menu,#game').hide(); $(`#${id}`).fadeIn(); }

        function hReg() {
            let u=$('#r-u').val().trim(), p=$('#r-p').val().trim();
            if(!u || db[u]) return alert("User sudah ada!");
            db[u]={p}; localStorage.setItem('chess_manual_db', JSON.stringify(db)); hSes(u);
        }
        function hLogin() {
            let u=$('#l-u').val().trim(), p=$('#l-p').val().trim();
            if(db[u] && db[u].p===p) hSes(u); else alert("Login Gagal!");
        }
        function hSes(u) { me=u; sessionStorage.setItem('u', u); nav('menu'); $('#u-display').text("Halo, "+u); }

        // --- BOT AI ---
        function startAI(lv) { botLV=lv; mySide='white'; initG('white', true); }
        function aiMove() {
            let moves = game.moves();
            if (game.game_over()) return;
            let m = (botLV==='easy') ? moves[Math.floor(Math.random()*moves.length)] : moves[0];
            game.move(m); board.position(game.fen()); checkEnd();
        }

        // --- GAME CORE ---
        function initG(side, isBot) {
            nav('game'); game.reset();
            $('#g-status').text(isBot ? "VS KOMPUTER" : "VS PEMAIN");
            setTimeout(() => {
                board = Chessboard('board', {
                    draggable: true, orientation: side, position: 'start',
                    onDrop: (s, t) => {
                        let m = game.move({from: s, to: t, promotion: 'q'});
                        if (!m) return 'snapback';
                        if (!isBot) conn.send({t:'MOV', m:m});
                        checkEnd();
                        if (isBot) setTimeout(aiMove, 600);
                    },
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
            }, 500);
        }

        function checkEnd() { if(game.game_over()) finish(game.in_checkmate() ? (game.turn()===mySide[0]?"KALAH":"MENANG") : "SERI"); }
        function finish(t) { $('#res-text').text(t); $('#res-modal').css('display','flex'); }
        function logout() { sessionStorage.clear(); location.reload(); }
        function resign() { if(confirm("Keluar?")) { if(conn) conn.send({t:'RES'}); location.reload(); } }

        $(document).ready(() => { let s=sessionStorage.getItem('u'); if(s && db[s]) hSes(s); });
    </script>
</body>
</html>
