<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Pro - Official Domain</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root { --main: #27ae60; --bg: #0d0d0d; --card: #1a1a1a; --text: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app-container { background: var(--card); width: 90%; max-width: 400px; padding: 30px; border-radius: 25px; border: 1px solid #333; box-shadow: 0 30px 60px rgba(0,0,0,0.8); text-align: center; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; background: var(--main); color: white; transition: 0.3s; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        #menu, #game, #reg { display: none; }
        .lobby { background: #111; border-radius: 15px; padding: 15px; margin-top: 20px; border: 1px solid #222; max-height: 200px; overflow-y: auto; }
        .player { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #222; margin-bottom: 8px; border-radius: 8px; font-size: 14px; }
        
        /* CAPTCHA STYLE */
        .captcha-box { background: #f9f9f9; border-radius: 4px; padding: 10px; margin: 15px 0; display: flex; align-items: center; color: #555; font-size: 13px; }
        .circle { width: 22px; height: 22px; border: 2px solid #ccc; margin-right: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: white; }
        .circle.load { border-radius: 50%; border-top-color: #4285f4; animation: spin 1s infinite linear; }
        .circle.done { background: var(--main); border-color: var(--main); color: white; }
        .circle.done::after { content: 'âœ“'; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #board { width: 100%; margin: 20px 0; border-radius: 8px; overflow: hidden; border: 3px solid #333; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="login">
            <h1 style="color: var(--main); margin-bottom: 5px;">CHESS PRO</h1>
            <p style="font-size: 12px; color: #777; margin-bottom: 30px;">GLOBAL MULTIPLAYER</p>
            <input type="text" id="l-u" placeholder="Username">
            <input type="password" id="l-p" placeholder="Password">
            <div class="captcha-box">
                <div class="circle" id="l-c" onclick="verify('login')"></div> I'm not a robot
            </div>
            <button id="l-b" onclick="handleL()" disabled>MASUK</button>
            <p style="font-size: 12px;">Baru? <span onclick="nav('reg')" style="color:var(--main); cursor:pointer;">Daftar Akun</span></p>
        </div>

        <div id="reg">
            <h2>BUAT AKUN</h2>
            <input type="text" id="r-u" placeholder="Username">
            <input type="password" id="r-p" placeholder="Password">
            <div class="captcha-box">
                <div class="circle" id="r-c" onclick="verify('reg')"></div> I'm not a robot
            </div>
            <button id="r-b" onclick="handleR()" disabled>DAFTAR</button>
            <p style="font-size: 12px;"><span onclick="nav('login')" style="color:var(--main); cursor:pointer;">Balik Login</span></p>
        </div>

        <div id="menu">
            <div style="text-align: left; margin-bottom: 20px;">
                <div id="disp-name" style="font-size: 22px; font-weight: bold; color: var(--main);"></div>
                <div id="disp-streak" style="font-size: 12px; color: #f1c40f;">ðŸ”¥ 0 WIN STREAK</div>
            </div>
            <div class="lobby">
                <div style="font-size: 11px; font-weight: bold; color: #555; margin-bottom: 10px;">LOBBY AKTIF</div>
                <div id="plist"></div>
            </div>
            <button onclick="logout()" style="background: transparent; color: #555; border: 1px solid #333; font-size: 11px; margin-top: 30px;">LOGOUT</button>
        </div>

        <div id="game">
            <div id="status" style="font-size: 12px; padding: 10px; background: #222; border-radius: 10px;">Menunggu lawan...</div>
            <div id="board"></div>
            <button onclick="resign()" style="background: #c0392b;">MENYERAH</button>
        </div>
    </div>

    <div id="overlay">
        <h1 id="res-h" style="font-size: 50px; color: var(--main);"></h1>
        <p id="res-p" style="color: #888;"></p>
        <button onclick="location.reload()" style="width: 220px; margin-top: 40px;">KEMBALI KE LOBBY</button>
    </div>

    <script>
        let board, game = new Chess(), peer = new Peer(), conn = null, side = '', myPeerId = '';
        let myName = "", oppName = "", vDone = { login: false, reg: false };
        let db = JSON.parse(localStorage.getItem('chess_vFinal') || '{}');

        function verify(m) {
            if(vDone[m]) return;
            $(`#${m[0]}-c`).addClass('load');
            setTimeout(() => {
                $(`#${m[0]}-c`).removeClass('load').addClass('done');
                vDone[m] = true; $(`#${m[0]}-b`).prop('disabled', false);
            }, 1200);
        }

        function nav(m) {
            $('.circle').removeClass('done load'); vDone = {login:false, reg:false};
            $('button').prop('disabled', true);
            $('#login, #reg').hide(); $(`#${m}`).fadeIn();
        }

        function handleR() {
            let u = $('#r-u').val().trim(), p = $('#r-p').val().trim();
            if(!u || db[u]) return alert("Username tidak tersedia!");
            db[u] = { p, s: 0 }; save(); proceed(u);
        }

        function handleL() {
            let u = $('#l-u').val().trim(), p = $('#l-p').val().trim();
            if(db[u] && db[u].p === p) proceed(u);
            else alert("Login Salah!");
        }

        function proceed(u) {
            myName = u; sessionStorage.setItem('u', u);
            $('#login, #reg').hide(); $('#menu').fadeIn();
            $('#disp-name').text(u); $('#disp-streak').text("ðŸ”¥ " + db[u].s + " WIN STREAK");
            startLobby();
        }

        peer.on('open', (id) => { myPeerId = id; });
        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (d) => {
                if(d.t === 'INV') {
                    if(confirm(d.f + " mengajak tanding. Terima?")) {
                        side = 'white'; conn.send({t:'ACC', f:myName}); launch('white');
                    }
                } else if(d.t === 'ACC') { side = 'black'; launch('black'); }
                else if(d.t === 'MOV') { game.move(d.m); board.position(game.fen()); checkWin(); }
                else if(d.t === 'RES') { end("MENANG", true); }
            });
        });

        function startLobby() {
            setInterval(() => {
                if(!myName || !$('#menu').is(':visible')) return;
                localStorage.setItem('chess_on_'+myPeerId, JSON.stringify({n:myName, s:db[myName].s, t:Date.now()}));
                $('#plist').empty();
                for(let i=0; i<localStorage.length; i++){
                    let k = localStorage.key(i);
                    if(k.startsWith('chess_on_') && k !== 'chess_on_'+myPeerId){
                        let p = JSON.parse(localStorage.getItem(k));
                        if(Date.now() - p.t < 4000) {
                            $('#plist').append(`<div class="player">
                                <span><b>${p.n}</b> (ðŸ”¥${p.s})</span>
                                <button onclick="sendInv('${k.split('_')[2]}','${p.n}')" style="width:60px; padding:6px; margin:0; font-size:10px;">MAIN</button>
                            </div>`);
                        }
                    }
                }
            }, 3000);
        }

        function sendInv(tid, tn) {
            oppName = tn; conn = peer.connect(tid);
            conn.on('open', () => conn.send({t:'INV', f:myName}));
        }

        function launch(s) {
            $('#menu').hide(); $('#game').fadeIn();
            $('#status').text("Sisi Kamu: " + (s==='white'?'PUTIH':'HITAM'));
            setTimeout(() => {
                board = Chessboard('board', {
                    draggable: true, orientation: s, position: 'start',
                    onDragStart: (a, b) => { if(game.game_over() || game.turn() !== s[0]) return false; },
                    onDrop: (a, b) => {
                        let m = game.move({from:a, to:b, promotion:'q'});
                        if(!m) return 'snapback';
                        conn.send({t:'MOV', m:m}); checkWin();
                    },
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
            }, 500);
        }

        function checkWin() {
            if(game.game_over()) {
                let win = game.in_checkmate() && game.turn() !== side[0];
                end(win ? "MENANG" : "KALAH", win);
            }
        }

        function end(t, win) {
            if(win) db[myName].s++; else db[myName].s = 0;
            save(); $('#res-h').text(t); $('#res-p').text(win ? "Selamat, kamu hebat!" : "Jangan menyerah, coba lagi!");
            $('#overlay').css('display','flex');
        }

        function save() { localStorage.setItem('chess_vFinal', JSON.stringify(db)); }
        function logout() { sessionStorage.clear(); location.reload(); }
        function resign() { if(confirm("Nyerah sekarang?")) { conn.send({t:'RES'}); end("KALAH", false); } }

        $(document).ready(() => {
            let s = sessionStorage.getItem('u');
            if(s && db[s]) proceed(s);
        });
    </script>
</body>
</html>
