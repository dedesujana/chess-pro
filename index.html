<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Pro - Original Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root { --p: #2ecc71; --b: #0a0a0a; --c: #151515; --s: #3498db; --r: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--b); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app { background: var(--c); width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; border: 1px solid #222; box-shadow: 0 30px 60px rgba(0,0,0,0.8); text-align: center; }
        
        input { width: 100%; padding: 15px; margin: 10px 0; background: #111; border: 1px solid #333; color: white; border-radius: 10px; box-sizing: border-box; outline: none; }
        button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: var(--p); color: white; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-blue { background: var(--s); }
        .btn-red { background: var(--r); }
        
        #menu, #game, #reg, #bot-menu { display: none; }
        .lobby-box { background: #000; border-radius: 12px; padding: 15px; margin-top: 15px; border: 1px solid #222; height: 180px; overflow-y: auto; }
        .p-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #1a1a1a; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--s); }
        
        #board { width: 100%; margin: 20px 0; border: 4px solid #333; border-radius: 8px; }
        .pop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        
        .status { font-size: 11px; margin-bottom: 15px; padding: 5px; border-radius: 5px; background: #222; }
    </style>
</head>
<body>

    <div class="app">
        <div id="login">
            <h1 style="color: var(--p); margin-bottom: 5px;">CHESS PRO</h1>
            <p style="font-size: 11px; color: #666; margin-bottom: 30px;">STABLE VERSION</p>
            <input type="text" id="l-u" placeholder="Username">
            <input type="password" id="l-p" placeholder="Password">
            <button onclick="handleLogin()">MASUK</button>
            <p style="font-size: 12px;">Belum punya akun? <span onclick="nav('reg')" style="color:var(--p); cursor:pointer;">Daftar</span></p>
        </div>

        <div id="reg">
            <h2>BUAT AKUN</h2>
            <input type="text" id="r-u" placeholder="Username Baru">
            <input type="password" id="r-p" placeholder="Password Baru">
            <button onclick="handleReg()">DAFTAR SEKARANG</button>
            <p style="font-size: 12px;"><span onclick="nav('login')" style="color:var(--p); cursor:pointer;">Kembali ke Login</span></p>
        </div>

        <div id="menu">
            <div id="user-display" style="font-size: 22px; font-weight: bold; color: var(--p); text-align: left; margin-bottom: 10px;"></div>
            <button class="btn-blue" onclick="nav('bot-menu')">VS KOMPUTER (AI)</button>
            
            <div style="margin-top: 20px; text-align: left; font-size: 12px; color: #888;">LOBBY MULTIPLAYER:</div>
            <div class="lobby-box">
                <div id="player-list"></div>
            </div>
            <button onclick="logout()" style="background:none; border:1px solid #333; color:#555; margin-top:20px; font-size:11px;">LOGOUT</button>
        </div>

        <div id="bot-menu">
            <h3>PILIH LEVEL AI</h3>
            <button onclick="playBot('easy')">EASY (Asal Jalan)</button>
            <button class="btn-blue" onclick="playBot('medium')">MEDIUM (Mulai Mikir)</button>
            <button class="btn-red" onclick="playBot('hard')">HARD (Sangat Sulit)</button>
            <button onclick="nav('menu')" style="background:none; color:var(--r)">KEMBALI</button>
        </div>

        <div id="game">
            <div id="game-info" class="status"></div>
            <div id="board"></div>
            <button class="btn-red" onclick="resign()">MENYERAH / KELUAR</button>
        </div>
    </div>

    <div class="pop" id="result-modal">
        <h1 id="result-text" style="font-size: 50px;"></h1>
        <button onclick="location.reload()" style="width: 200px;">BALIK KE LOBBY</button>
    </div>

    <script>
        let board, game = new Chess(), peer = new Peer(), conn = null, mySide = '', myID = '', currentBot = null;
        let me = "";
        let database = JSON.parse(localStorage.getItem('chess_db_v1') || '{}');

        // --- AUTH & NAV ---
        function nav(id) { $('#login,#reg,#menu,#bot-menu,#game').hide(); $(`#${id}`).fadeIn(); }

        function handleReg() {
            let u = $('#r-u').val().trim(), p = $('#r-p').val().trim();
            if(!u || database[u]) return alert("Username sudah ada atau kosong!");
            database[u] = { p }; 
            localStorage.setItem('chess_db_v1', JSON.stringify(database));
            startSession(u);
        }

        function handleLogin() {
            let u = $('#l-u').val().trim(), p = $('#l-p').val().trim();
            if(database[u] && database[u].p === p) startSession(u);
            else alert("Login gagal!");
        }

        function startSession(u) {
            me = u; sessionStorage.setItem('active_user', u);
            nav('menu'); $('#user-display').text("Halo, " + u);
            startLobbyLoop();
        }

        // --- MULTIPLAYER LOGIC ---
        peer.on('open', (id) => myID = id);

        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if(data.type === 'INVITE') {
                    if(confirm(data.from + " mengajak tanding! Terpencet OK = Setuju.")) {
                        mySide = 'white'; 
                        conn.send({type: 'ACCEPT', from: me});
                        initGame('white', false);
                    }
                } else if(data.type === 'ACCEPT') {
                    mySide = 'black';
                    initGame('black', false);
                } else if(data.type === 'MOVE') {
                    game.move(data.move);
                    board.position(game.fen());
                    checkGameOver();
                } else if(data.type === 'RESIGN') {
                    showResult("MENANG");
                }
            });
        });

        function startLobbyLoop() {
            setInterval(() => {
                if(!me || !$('#menu').is(':visible')) return;
                // Broadcast online status
                localStorage.setItem('online_' + myID, JSON.stringify({name: me, time: Date.now()}));
                
                // Refresh list
                $('#player-list').empty();
                for(let i=0; i<localStorage.length; i++){
                    let key = localStorage.key(i);
                    if(key.startsWith('online_') && key !== 'online_' + myID){
                        let player = JSON.parse(localStorage.getItem(key));
                        if(Date.now() - player.time < 4000) {
                            $('#player-list').append(`
                                <div class="p-card">
                                    <span><b>${player.name}</b></span>
                                    <button onclick="sendInvite('${key.split('_')[1]}')" style="width:80px; padding:8px; margin:0; font-size:11px;">TANTANG</button>
                                </div>
                            `);
                        }
                    }
                }
            }, 3000);
        }

        function sendInvite(targetID) {
            conn = peer.connect(targetID);
            conn.on('open', () => {
                alert("Tantangan terkirim...");
                conn.send({type: 'INVITE', from: me});
            });
        }

        // --- BOT AI LOGIC ---
        function playBot(level) {
            currentBot = level;
            mySide = 'white';
            initGame('white', true);
        }

        function botMove() {
            if (game.game_over()) return;
            let moves = game.moves();
            let move;

            if (currentBot === 'easy') {
                move = moves[Math.floor(Math.random() * moves.length)];
            } else {
                // Heuristic simple: prioritize captures
                moves.sort((a, b) => {
                    let moveA = game.move(a); game.undo();
                    let moveB = game.move(b); game.undo();
                    return (moveB.captured ? 1 : 0) - (moveA.captured ? 1 : 0);
                });
                move = (currentBot === 'hard' && Math.random() > 0.3) ? moves[0] : moves[Math.floor(Math.random() * Math.min(3, moves.length))];
            }

            game.move(move);
            board.position(game.fen());
            checkGameOver();
        }

        // --- GAME CORE ---
        function initGame(side, isBot) {
            nav('game');
            game.reset();
            $('#game-info').text(isBot ? "MODE: VS BOT ("+currentBot.toUpperCase()+")" : "MODE: MULTIPLAYER");
            
            setTimeout(() => {
                board = Chessboard('board', {
                    draggable: true,
                    orientation: side,
                    position: 'start',
                    onDragStart: (source, piece) => {
                        if (game.game_over() || game.turn() !== side[0]) return false;
                    },
                    onDrop: (source, target) => {
                        let m = game.move({from: source, to: target, promotion: 'q'});
                        if (m === null) return 'snapback';
                        
                        if (!isBot) conn.send({type: 'MOVE', move: m});
                        checkGameOver();
                        if (isBot) setTimeout(botMove, 600);
                    },
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                });
            }, 500);
        }

        function checkGameOver() {
            if(game.game_over()) {
                if(game.in_checkmate()) showResult(game.turn() === mySide[0] ? "KALAH" : "MENANG");
                else showResult("SERI");
            }
        }

        function showResult(t) { $('#result-text').text(t); $('#result-modal').css('display', 'flex'); }
        function logout() { sessionStorage.clear(); location.reload(); }
        function resign() { if(confirm("Keluar?")) { if(conn) conn.send({type:'RESIGN'}); location.reload(); } }

        $(document).ready(() => {
            let savedUser = sessionStorage.getItem('active_user');
            if(savedUser && database[savedUser]) startSession(savedUser);
        });
    </script>
</body>
</html>
